{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Estabelecimentos</title>

  <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <style>
.table-responsive{
  display: block;
  width: 100%;
  overflow-x: auto !important;     
  overflow-y: visible !important;  
  -webkit-overflow-scrolling: touch;
}
.table-responsive > .table{
  min-width: 1690px;
  margin-bottom: 0;
}
.main, .content{
  overflow-x: visible;
}
.table-div-all{
  background-color:#FFF;
  transition:.4s;
  cursor:pointer;
  color:black;
  height:100%;
  border-radius:.25rem;
  display:flex;
  flex-direction:column;
  justify-content:flex-start;
  padding:15px;
  box-shadow:.2rem .2rem .3rem .1rem rgb(191,191,191);
}

.table-div-all .table{
  font-size:1.2rem;
  width:100%;
  table-layout: fixed;           
  text-align:center;
}

.table-div-all .table th,
.table-div-all .table td{
  vertical-align:middle;
  font-size:.85rem;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: anywhere;
  hyphens: auto;
}
.filters .form-control,
.filters .form-select{
  border-color: var(--bs-border-color);
  background-color: #fff;
}
.filters .form-control:hover,
.filters .form-select:hover{
  border-color: var(--bs-border-color);
}
.filters .form-control:focus,
.filters .form-select:focus{
  border-color: var(--bs-primary);
  box-shadow: 0 0 0 .25rem rgba(13,110,253,.25);
  outline: 0;
}
.filters .form-control::placeholder{
  color: var(--bs-secondary-color);
  opacity: 1;
}
.filters .dropdown .btn-outline-secondary{
  --bs-btn-color: var(--bs-secondary);
  --bs-btn-border-color: var(--bs-secondary);
  --bs-btn-hover-color: #fff;
  --bs-btn-hover-bg: var(--bs-secondary);
  --bs-btn-hover-border-color: var(--bs-secondary);
  --bs-btn-focus-shadow-rgb: 108,117,125;
  --bs-btn-active-color: #fff;
  --bs-btn-active-bg: var(--bs-secondary);
  --bs-btn-active-border-color: var(--bs-secondary);
}
.filters .dropdown .btn-outline-secondary:focus,
.filters .dropdown .btn-outline-secondary.show{
  border-color: var(--bs-btn-border-color);
  box-shadow: 0 0 0 .25rem rgba(var(--bs-btn-focus-shadow-rgb), .5);
}

.dropdown-menu.filtro-menu{
  position: absolute;           
  z-index: 1080;                   
  border: 1px solid #b5b5b5ff;      
  overflow-y: auto;               
  overflow-x: hidden;
  overscroll-behavior: contain;
  -webkit-overflow-scrolling: touch;
  width: max(260px, min(420px, 96vw)); 
}
  </style>
</head>
<body>
<div class="wrapper">
  {% include "others/sidebar.html" %}
  <div class="main">
    <nav class="navbar navbar-expand px-4 py-2">
      <a href="#" class="navbar-text-lg-start inline pt-2 d-flex align-items-center">
        <img src="{% static 'images/BBTS.png' %}" alt="Logo" class="mx-3 mb-2" />
        <h3 class="mx-3"><strong>Sistema de Controle de Estabelecimento - SICOE</strong></h3>
      </a>
    </nav>

    <main class="content px-3 py-4">
      {% if messages %}
      <div id="msg-container" class="position-fixed top-4 end-0 me-4 mt-3 p-4" style="z-index:1080; width:fit-content; max-width:90%;">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-2" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
          </div>
        {% endfor %}
      </div>
      {% endif %}

      <div class="container-fluid">
        <div class="mb-3">
          <div class="row">
            <div class="col-12 col-lg-12 col-md-12 pb-3 mt-2">
              <div class="breadcrumb-div py-3 border-1">
                <ol class="breadcrumb my-1 mx-2 px-3">
                  <li class="breadcrumb-item"><a href="{% url 'home' %}">Início</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Estabelecimentos</li>
                </ol>
                <h1 class="fw-bold fs-2 mx-5 mt-3">Estabelecimentos</h1>
              </div>
            </div>

            <div class="col-12 col-lg-12 col-md-12">
              <div class="table-div-all py-4 px-4 border-1">
                <div class="col-12 col-lg-12 col-md-12 mb-3">
                  <div class="table-div-all py-3 px-3 border-1">
                    <div class="small mt-3 mx-3">
                      <a href="{% url 'cnpj_list' %}" class="btn btn-primary"><strong>Unidades</strong></a>
                    </div>

                    <div class="my-3 mx-3">
                      Exibindo <b id="count-start">{{ page_obj.start_index }}</b>-<b id="count-end">{{ page_obj.end_index }}</b>
                      de <b id="count-total">{{ page_obj.paginator.count }}</b> itens.
                    </div>
                  </div>
                </div>

                <div class="col-12 col-lg-12 col-md-12 mb-3">
                  <div class="table-div-all py-3 px-3 border-1">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover align-middle small">
                        <thead>
                          <tr>
                            <th width="100px"><a>Região</a></th>
                            <th width="90px"><a>Estado</a></th>
                            <th width="160px"><a>Cidade</a></th>
                            <th width="220px"><a>Estabelecimento</a></th>
                            <th width="600px"><a>Endereço</a></th>
                            <th width="140px"><a>Propriedade</a></th>
                            <th width="160px"><a>Área Gestora</a></th>
                            <th width="220px" class="text-center">&nbsp;</th>
                          </tr>
                          <tr class="filters">
                            <td><input type="text" id="region-filter"   class="form-control form-control-sm" /></td>
                            <td><input type="text" id="state-filter"    class="form-control form-control-sm" /></td>
                            <td><input type="text" id="city-filter"     class="form-control form-control-sm" /></td>
                            <td>
                              <select id="center-filter" class="form-select form-select-sm" aria-label="Filtro por estabelecimento">
                                <option value="">Todos</option>
                              </select>
                            </td>
                            <td><input type="text" id="address-filter"  class="form-control form-control-sm" /></td>
                            <td><input type="text" id="property-filter" class="form-control form-control-sm" /></td>
                            <td><input type="text" id="manage-filter"   class="form-control form-control-sm" /></td>
                            <td></td>
                          </tr>
                        </thead>

                        <tbody id="establishment-body">
                        {% for establishment in establishment_l %}
                          <tr>
                            <td>{{ establishment.est_region }}</td>
                            <td>{{ establishment.est_state }}</td>
                            <td>{{ establishment.est_city }}</td>
                            <td>{{ establishment.est_center }}</td>
                            <td>{{ establishment.est_address }}</td>
                            <td>{{ establishment.est_property }}</td>
                            <td>{{ establishment.est_manage }}</td>
                            <td>
                              <div class="d-flex justify-content-end">
                                <div>
                                  <a href="{% url 'establishment_update' establishment.est_id %}" class="btn btn-sm btn-outline-primary">Editar</a>
                                </div>
                              </div>
                            </td>
                          </tr>
                        {% empty %}
                          <tr><td colspan="8">Nenhum estabelecimento encontrado.</td></tr>
                        {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>    
                </div>

                <nav class="mt-4" aria-label="Page navigation" id="pag">
                  <ul class="pagination justify-content-center" id="pagination">
                    {% if page_obj.has_previous %}
                      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
                    {% else %}
                      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    {% if page_obj.number < 10 %}
                      {% for num in page_obj.paginator.page_range %}
                        {% if num <= 10 %}
                          {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                          {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      {% for num in page_obj.paginator.page_range %}
                        {% if num >= page_obj.number|add:"-9" and num <= page_obj.number %}
                          {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                          {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                          {% endif %}
                          {% endif %}
                          {% endfor %}
                          {% endif %}
                          
                          {% if page_obj.has_next %}
                          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
                          {% else %}
                          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                          {% endif %}
                        </ul>
                      </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
<script>
$(function () {
  const urlList = "{% url 'establishment_list' %}";
  const FIELDS = [
    { id: '#region-filter',   param: 'region',   key: 'est_region',   label: 'Região' },
    { id: '#state-filter',    param: 'state',    key: 'est_state',    label: 'Estado' },
    { id: '#city-filter',     param: 'city',     key: 'est_city',     label: 'Cidade' },
    { id: '#center-filter',   param: 'center',   key: 'est_center',   label: 'Estabelecimento' },
    { id: '#address-filter',  param: 'address',  key: 'est_address',  label: 'Endereço' },
    { id: '#property-filter', param: 'property', key: 'est_property', label: 'Propriedade' },
    { id: '#manage-filter',   param: 'manage',   key: 'est_manage',   label: 'Área Gestora' },
  ];

  const optionTokens = Object.fromEntries(FIELDS.map(f => [f.param, 0]));
  let latestLoadToken = 0;
  let pendingCloseParam = null; 
  const esc = (s) => (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
  const uniqPush = (set, arr, v) => { if (!set.has(v) && v !== '') { set.add(v); arr.push(v); } };

  function ensureDropdown(field) {
    const $orig = $(field.id);
    if (!$orig.length || $orig.data('enhanced')) return;

    const id = $orig.attr('id');
    const currentVal = ($orig.val && $orig.val()) || '';

    const $wrap = $(`
      <div class="dropdown w-100" data-bs-boundary="viewport">
        <button type="button"
                class="btn btn-sm btn-outline-secondary w-100 text-truncate"
                data-bs-toggle="dropdown"
                data-bs-auto-close="outside"
                data-bs-display="static"
                aria-expanded="false"
                title="${esc(field.label)}">Todos</button>
        <ul class="dropdown-menu filtro-menu w-100 p-0" data-param="${field.param}"></ul>
        <input type="hidden" id="${id}">
      </div>
    `);

    $orig.replaceWith($wrap);
    $wrap.find('input[type="hidden"]').val(currentVal);
    $wrap.data('enhanced', true);

    rebuildDropdownOptions(field, [], false);
  }

  function els(field){
    const $hidden = $(field.id);
    const $wrap   = $hidden.closest('.dropdown');
    return {
      $hidden,
      $wrap,
      $menu: $wrap.find('.dropdown-menu'),
      $btn:  $wrap.find('[data-bs-toggle="dropdown"]')
    };
  }

  function setDropdownLoading(field){
    const { $menu } = els(field);
    $menu.html(`
      <li><button type="button" class="dropdown-item" data-value="">Todos</button></li>
      <li><div class="px-3 py-2 small text-body-secondary">Carregando opções…</div></li>
    `);
  }

  function rebuildDropdownOptions(field, values, keepSelection){
    const { $menu, $hidden, $btn } = els(field);
    const prev = (keepSelection ? $hidden.val() : '') || '';

    let html = `<li><button type="button" class="dropdown-item${prev===''?' active':''}" data-value="">Todos</button></li>`;
    values.forEach(v => {
      const isActive = (v === prev) ? ' active' : '';
      html += `<li><button type="button" class="dropdown-item${isActive}" data-value="${esc(v)}" title="${esc(v)}">${esc(v)}</button></li>`;
    });

    $menu.html(html);
    $btn.text(prev || 'Todos').attr('title', prev || 'Todos');
  }

  function capDropdownToTable(dropEl){
    const $dd   = $(dropEl);
    const $menu = $dd.find('.dropdown-menu.filtro-menu');
    if (!$menu.length) return;

    const gap = 8; 
    const containerEl  = $dd.closest('.table-responsive')[0] || document.documentElement;
    const cRect = containerEl.getBoundingClientRect();
    const tRect = dropEl.getBoundingClientRect();
    let avail = Math.floor(cRect.bottom - tRect.bottom - gap);
    const vpAvail = Math.floor(window.innerHeight - tRect.bottom - gap);
    if (!Number.isFinite(avail)) avail = vpAvail;

    if (avail < 120) avail = Math.max(120, vpAvail);

    $menu.css({
      'max-height': `${avail}px`,
      'overflow-y': 'auto',
      'overflow-x': 'hidden'
    });
  }

  function reflowOpenDropdownHeights(){
    document.querySelectorAll('.dropdown .dropdown-menu.filtro-menu.show')
      .forEach(m => capDropdownToTable(m.closest('.dropdown')));
  }

  $(document).on('show.bs.dropdown', '.dropdown', function(){
    capDropdownToTable(this);
  });

  $(document).on('shown.bs.dropdown', '.dropdown', function(){
    capDropdownToTable(this);
  });

  $(window).on('resize', function(){
    reflowOpenDropdownHeights();
  });

  $(document).on('scroll', '.table-responsive', function(){
    reflowOpenDropdownHeights();
  });

  $(window).on('scroll', function(){
    reflowOpenDropdownHeights();
  });

  $(document).on('click', '.dropdown-menu[data-param] .dropdown-item', function(e){
    e.preventDefault();
    const $menu = $(this).closest('.dropdown-menu');
    const param = $menu.data('param');
    const field = FIELDS.find(f => f.param === param);
    if (!field) return;

    const value = $(this).data('value') || '';
    const { $hidden, $btn } = els(field);

    $menu.find('.dropdown-item.active').removeClass('active');
    $(this).addClass('active');

    $hidden.val(value).trigger('change');
    $btn.text(value || 'Todos').attr('title', value || 'Todos');

    pendingCloseParam = field.param;
  });

  FIELDS.forEach(ensureDropdown);

  function getCurrentFilters() {
    const o = {};
    FIELDS.forEach(f => { o[f.param] = $(f.id).val() || ''; });
    return o;
  }

  function baseFiltersExcept(exceptParam) {
    const filters = getCurrentFilters();
    filters[exceptParam] = ''; 
    return filters;
  }

  function fetchPage(params) {
    return $.ajax({ url: urlList, data: params, dataType: 'json' });
  }

  function renderRows(results) {
    const $tbody = $('#establishment-body').empty();
    if (!Array.isArray(results) || !results.length) {
      $tbody.append('<tr><td colspan="8">Nenhum estabelecimento encontrado.</td></tr>');
      return;
    }
    results.forEach(est => {
      $tbody.append(`
        <tr>
          <td>${esc(est.est_region)}</td>
          <td>${esc(est.est_state)}</td>
          <td>${esc(est.est_city)}</td>
          <td>${esc(est.est_center)}</td>
          <td>${esc(est.est_address)}</td>
          <td>${esc(est.est_property)}</td>
          <td>${esc(est.est_manage)}</td>
          <td class="text-end">
            <div class="d-flex justify-content-end">
              <div>
                <a href="/administrador/estabelecimento/${esc(est.est_id)}/editar/" class="btn btn-sm btn-outline-primary">Editar</a>
              </div>
            </div>
          </td>
        </tr>
      `);
    });
  }

  function renderCounters(start, end, total) {
    $('#count-start').text(start);
    $('#count-end').text(end);
    $('#count-total').text(total);
  }

  function renderPagination(current, total){
    const pag = document.getElementById('pagination');
    if (!pag) return;
    pag.innerHTML = '';

    const start = Math.max(1, current - 9);
    const end   = Math.min(total, start + 9);

    if (current > 1) {
      pag.innerHTML += `<li class="page-item">
        <a class="page-link" href="?page=${current - 1}" data-page="${current - 1}" aria-label="Anterior">&laquo;</a>
      </li>`;
    } else {
      pag.innerHTML += `<li class="page-item disabled">
        <span class="page-link" aria-disabled="true">&laquo;</span>
      </li>`;
    }
    for (let i = start; i <= end; i++) {
      if (i === current) {
        pag.innerHTML += `<li class="page-item active" aria-current="page">
          <span class="page-link">${i}</span>
        </li>`;
      } else {
        pag.innerHTML += `<li class="page-item">
          <a class="page-link" href="?page=${i}" data-page="${i}">${i}</a>
        </li>`;
      }
    }
    if (current < total) {
      pag.innerHTML += `<li class="page-item">
        <a class="page-link" href="?page=${current + 1}" data-page="${current + 1}" aria-label="Próxima">&raquo;</a>
      </li>`;
    } else {
      pag.innerHTML += `<li class="page-item disabled">
        <span class="page-link" aria-disabled="true">&raquo;</span>
      </li>`;
    }
  }

  function renderSinglePagePagination() {
    const $p = $('#pagination').empty();
    $p.append('<li class="page-item disabled"><span class="page-link">&laquo;</span></li>');
    $p.append('<li class="page-item active"><span class="page-link">1</span></li>');
    $p.append('<li class="page-item disabled"><span class="page-link">&raquo;</span></li>');
  }

  function returnDropdownToPlace() {
    if (!pendingCloseParam) return;

    const field = FIELDS.find(f => f.param === pendingCloseParam);
    if (!field) { pendingCloseParam = null; return; }

    const { $wrap, $menu, $hidden } = els(field);
    const btnEl = $wrap.find('[data-bs-toggle="dropdown"]')[0];
    if (btnEl) {
      const inst = bootstrap.Dropdown.getOrCreateInstance(btnEl);
      inst.hide();
    }

    const selected = $hidden.val() || '';
    if (selected) {
      rebuildDropdownOptions(field, [selected], true);
    }

    $menu.scrollTop(0);

    pendingCloseParam = null; 
  }

  async function refreshOptionsForField(field) {
    const { $hidden } = els(field);
    const selected = $hidden.val() || '';

    if (selected) {
      rebuildDropdownOptions(field, [selected], true);
      return;
    }

    const token = ++optionTokens[field.param];
    const base = baseFiltersExcept(field.param);

    setDropdownLoading(field);

    try {
      const first = await fetchPage({ ...base, page: 1 });
      if (token !== optionTokens[field.param]) return;

      const totalPages = Math.max(1, first.num_pages || 1);
      const seen = new Set();
      const values = [];
      (first.results || []).forEach(r => uniqPush(seen, values, (r[field.key] || '').toString()));

      rebuildDropdownOptions(field, values, true);

      if (totalPages > 1) {
        const reqs = [];
        for (let p = 2; p <= totalPages; p++) {
          reqs.push(
            fetchPage({ ...base, page: p }).then(pg => {
              if (token !== optionTokens[field.param]) return;
              const adds = [];
              (pg.results || []).forEach(r => {
                const v = (r[field.key] || '').toString();
                if (v && !seen.has(v)) { seen.add(v); adds.push(v); }
              });
              if (adds.length) {
                values.push(...adds);
                rebuildDropdownOptions(field, values, true);
              }
            }).catch(() => {})
          );
        }
        await Promise.allSettled(reqs);
      }
    } finally {
      const { $menu } = els(field);
      $menu.find('.text-body-secondary:contains("Carregando")').closest('li').remove();
    }
  }

  async function refreshAllOptions() {
    await Promise.allSettled(FIELDS.map(refreshOptionsForField));
  }

  function loadAllPaginated(page = 1) {
    const token = ++latestLoadToken;
    const filters = getCurrentFilters();
    if (!filters.center) filters.center = '';

    fetchPage({ ...filters, page }).done(async (resp) => {
      if (token !== latestLoadToken) return;

      renderRows(resp.results || []);
      renderCounters(resp.start_index ?? 0, resp.end_index ?? 0, resp.count ?? 0);
      renderPagination(resp.current_page ?? 1, resp.num_pages ?? 1);

      await refreshAllOptions();
      returnDropdownToPlace();
      reflowOpenDropdownHeights();
    });
  }

  async function loadOnlySelectedCenter(centerValue) {
    const token = ++latestLoadToken;

    const filters = getCurrentFilters();
    filters.center = centerValue;

    renderRows([]);
    renderCounters(0, 0, 0);
    renderSinglePagePagination();

    try {
      const first = await fetchPage({ ...filters, page: 1 });
      if (token !== latestLoadToken) return;

      const totalPages = Math.max(1, first.num_pages || 1);
      let all = (first.results || []).slice();

      if (totalPages > 1) {
        const reqs = [];
        for (let p = 2; p <= totalPages; p++) {
          reqs.push(fetchPage({ ...filters, page: p }).then(pg => {
            if (token !== latestLoadToken) return;
            all = all.concat(pg.results || []);
            renderRows(all);
            renderCounters(all.length ? 1 : 0, all.length, all.length);
            reflowOpenDropdownHeights(); 
          }).catch(() => {}));
        }
        await Promise.allSettled(reqs);
      }

      renderRows(all);
      renderCounters(all.length ? 1 : 0, all.length, all.length);
      renderSinglePagePagination();

      await refreshAllOptions();

      rebuildDropdownOptions(FIELDS.find(f => f.param === 'center'), [centerValue], true);

      returnDropdownToPlace();

      reflowOpenDropdownHeights();
    } catch (_) {}
  }

  FIELDS.forEach(f => {
    $(document).on('change', f.id, function () {
      const centerVal = $(FIELDS.find(x=>x.param==='center').id).val() || '';
      if (centerVal) {
        loadOnlySelectedCenter(centerVal);
      } else {
        loadAllPaginated(1);
      }
    });
  });

  $('#pagination').on('click', 'a.page-link', function (e) {
    e.preventDefault();
    const centerVal = $($('#center-filter')).val() || '';
    if (centerVal) return;

    const href = $(this).attr('href') || '';
    const qs   = href.split('?')[1] || '';
    const page = $(this).data('page') || parseInt(new URLSearchParams(qs).get('page') || '0', 10);

    if (page) loadAllPaginated(page);
  });

  loadAllPaginated(1);
});
</script>
</body>
</html>
