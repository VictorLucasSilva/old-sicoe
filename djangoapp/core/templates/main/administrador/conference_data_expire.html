{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Estabelecimentos</title>
    <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>

        .create-div-all {
            background-color: #FFF;
            transition: .4s;
            cursor: pointer;
            color: black;
            height: 100%;
            border-radius: .25rem;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            padding: 15px;
            box-shadow: .2rem .2rem .3rem .1rem rgb(191, 191, 191);
        }

        .create-div-all .table {
            font-size: 1.2rem;
            width: 100%;
            table-layout: fixed;
            text-align: center;
        }

        .create-div-all .table,
        .create-div-all .table td {
            word-wrap: break-word;
            vertical-align: middle;
            font-size: 0.85rem;
        }
        .date-wrapper .input-group-text{ cursor:pointer; }
        .calendar-overlay{
        position:absolute; inset:0 auto 0 0;
        width:2.75rem; opacity:0; z-index:3; cursor:pointer;
        }
        .input-group.position-relative{ position:relative; }
        .is-valid{ border-color:#198754; }
        .is-invalid{ border-color:#dc3545; }
    </style>
</head>
<body>
    <div class="wrapper">
        {% include "others/sidebar.html" %}
        <div class="main">
            <nav class="navbar navbar-expand px-4 py-2">
                <a href="#" class="navbar-text-lg-start inline pt-2 d-flex align-items-center">
                    <img src="{% static 'images/BBTS.png' %}" alt="Logo" class="mx-3 mb-2" />
                    <h3 class="mx-3"><strong>Sistema de Controle de Estabelecimento - SICOE</strong></h3>
                </a>
            </nav>
              <main class="content px-3 py-4">
                {% if messages %}
                  <div id="msg-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 1080; width: fit-content; max-width: 90%;">
                    {% for message in messages %}
                      <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-2" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
                      </div>
                    {% endfor %}
                  </div>
                {% endif %}
                  <div class="container-fluid">
                      <div class="mb-3">
                          <div class="row">
                              <div class="col-12 col-lg-12 col-md-12 pb-4 mt-2">
                                  <div class="breadcrumb-div py-3 border-1">
                                      <ol class="breadcrumb my-1 mx-2 px-3">
                                        <li class="breadcrumb-item"><a href="{% url 'home' %}">Início </a></li>
                                        <li class="breadcrumb-item"><a href="{% url 'attachment_list' %}">Anexos </a></li>
                                        <li class="breadcrumb-item"><a href="{% url 'attachment_conference' %}">Conferir</a></li>
                                        <li class="breadcrumb-item active" aria-current="page">Alteração de Data</li>
                                      </ol>
                                      <h1 class="fw-bold fs-2 mx-5 mt-3">Alteração de Data</h1>
                                  </div>
                              </div>
                          </div>
                          <div class="row">
                            <div class="col-12 col-lg-12 col-md-12">
                              <div class="create-div-all py-5 px-5 border-1">
                                <form method="POST" id="formDtExpire">
                                  {% csrf_token %}

                                  <div class="mb-4">
                                    <label for="center" class="form-label mb-2"><strong>Estabelecimento</strong></label>
                                    <input type="text" name="center" id="center" class="form-control" value="{{ attachment_l.att_center }}" disabled>
                                  </div>

                                  <div class="mb-4">
                                    <label for="doc" class="form-label mb-2"><strong>Documento</strong></label>
                                    <input type="text" name="doc" id="doc" class="form-control" value="{{ attachment_l.att_doc }}" disabled>
                                  </div>

                                <div class="mb-5 date-wrapper" id="dt-expire-wrapper">
                                    <label for="dt-expire-mask" class="form-label mb-2">
                                        <strong>Data de Saída:</strong>
                                    </label>

                                    <div class="input-group position-relative">
                                        <span class="input-group-text" id="icon-cal-expire" role="button" aria-label="Abrir calendário" tabindex="0">
                                        <i class="bi bi-calendar3"></i>
                                        </span>
                                        <input type="date" id="dt-expire-native" class="calendar-overlay" aria-label="Calendário nativo">
                                        <input
                                        type="text"
                                        id="dt-expire-mask"
                                        class="form-control date-br"
                                        inputmode="numeric"
                                        autocomplete="off"
                                        placeholder="DD/MM/AAAA"
                                        maxlength="10"
                                        aria-describedby="icon-cal-expire"
                                        >
                                    </div>
                                    <input
                                        type="hidden"
                                        name="{{ form.att_data_expire.name }}"
                                        id="att_data_expire_hidden"
                                        value="{{ attachment_l.att_data_expire|date:'Y-m-d' }}"
                                    >

                                <div class="invalid-feedback">Informe uma data no formato DD/MM/AAAA (hoje ou futura).</div>

                                {% if form.att_data_expire.errors %}
                                    <div class="text-danger small mt-1">
                                    {% for error in form.att_data_expire.errors %}
                                        {{ error }}
                                    {% endfor %}
                                    </div>
                                {% endif %}
                                </div>

                                  <button type="button" class="btn btn-primary" id="btnAbrirModalSalvar">Salvar</button>
                                  <a href="{% url 'attachment_conference' %}" class="btn btn-secondary">Voltar</a>
                                </form>
                              </div>
                            </div>
                          </div>
                      </div>
                  </div>
              </main>
              
                <div class="modal fade" id="modalConfirmarSalvar" tabindex="-1" aria-labelledby="modalConfirmarSalvarLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header text-black">
                                <h5 class="modal-title" id="modalConfirmarSalvarLabel">Confirmar Alteração</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                Tem certeza que deseja salvar a alteração da data?
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-primary" id="btnConfirmarSalvar">
                                    <span class="btn-text">Confirmar</span>
                                    <span id="loading-spinner-salvar" class="spinner-border spinner-border-sm ms-1" role="status" aria-hidden="true" style="display:none;"></span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
        <script src="{% static 'js/script.js' %}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const msgContainer = document.getElementById('msg-container');
                if (msgContainer) {
                    setTimeout(() => {
                        msgContainer.querySelectorAll('.alert').forEach(alert => {
                            bootstrap.Alert.getOrCreateInstance(alert).close();
                        });
                    }, 5000);
                }

                const form = document.getElementById('formDtExpire');
                const btnAbrirModal = document.getElementById('btnAbrirModalSalvar');
                const btnConfirmarSalvar = document.getElementById('btnConfirmarSalvar');
                const spinnerSalvar = document.getElementById('loading-spinner-salvar');

                btnAbrirModal.addEventListener('click', function (e) {
                    e.preventDefault();
                    new bootstrap.Modal(document.getElementById('modalConfirmarSalvar')).show();
                });

                function validateField(field, errorElement, messageEmpty) {
                    let value = field.value.trim();
                    if (!value) {
                        errorElement.textContent = messageEmpty;
                        errorElement.className = "text-danger small mt-1";
                        field.classList.add('is-invalid');
                        field.classList.remove('is-valid');
                    } else {
                        errorElement.textContent = "";
                        errorElement.className = "text-success small mt-1";
                        field.classList.remove('is-invalid');
                        field.classList.add('is-valid');
                    }
                }

                const rcd_fk_document = document.getElementById('{{ form.rcd_fk_document.id_for_label }}');
                const rcd_fk_document_error = document.getElementById('rcd_fk_document_error');

                if (rcd_fk_document) {
                    rcd_fk_document.addEventListener('change', function () {
                        validateField(rcd_fk_document, rcd_fk_document_error, "O campo Documento é obrigatório.");
                    });
                }
            });
        </script>
        <script>
            (function(){
            const mask    = document.getElementById('dt-expire-mask');
            const native  = document.getElementById('dt-expire-native');
            const hidden  = document.getElementById('att_data_expire_hidden');
            const wrapper = document.getElementById('dt-expire-wrapper');
            const feedback = wrapper.querySelector('.invalid-feedback');

            const pad2 = n => String(n).padStart(2,'0');
            const today0 = () => { const d = new Date(); d.setHours(0,0,0,0); return d; };
            const toISO = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
            const toBR  = d => `${pad2(d.getDate())}/${pad2(d.getMonth()+1)}/${d.getFullYear()}`;

            function parseBR(v){
                if(!/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return null;
                const [dd,mm,yy] = v.split('/').map(Number);
                const dt = new Date(yy, mm-1, dd, 0,0,0,0);
                if (dt.getFullYear()!==yy || dt.getMonth()!==mm-1 || dt.getDate()!==dd) return null;
                return dt;
            }

            native.min = toISO(today0());

            function mapRawIndexToFormatted(rawIdx){ let p = rawIdx; if(p>2) p+=1; if(p>4) p+=1; return p; }
            function formatFrom(value, caret){
                const raw = value.replace(/\D/g,'').slice(0,8);
                const rawBefore = value.slice(0,(caret ?? value.length)).replace(/\D/g,'').length;
                let formatted = '';
                if(raw.length<=2) formatted=raw;
                else if(raw.length<=4) formatted = raw.slice(0,2)+'/'+raw.slice(2);
                else formatted = raw.slice(0,2)+'/'+raw.slice(2,4)+'/'+raw.slice(4);
                let newCaret = mapRawIndexToFormatted(rawBefore);
                if(newCaret>formatted.length) newCaret=formatted.length;
                return {formatted,newCaret};
            }

            mask.addEventListener('keydown', (ev)=>{
                const val = mask.value;
                const pos = mask.selectionStart ?? 0;
                const nav = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];
                if (ev.key==='Backspace' && pos>0 && val[pos-1]==='/'){ ev.preventDefault(); mask.setSelectionRange(pos-1,pos-1); return; }
                if (ev.key==='Delete' && val[pos]==='/'){ ev.preventDefault(); mask.setSelectionRange(pos+1,pos+1); return; }
                if (nav.includes(ev.key) || /^\d$/.test(ev.key) || ev.ctrlKey || ev.metaKey) return;
                ev.preventDefault();
            });

            function applyMask(){
                const caret = mask.selectionStart ?? mask.value.length;
                const {formatted,newCaret} = formatFrom(mask.value, caret);
                mask.value = formatted;
                try{ mask.setSelectionRange(newCaret,newCaret); }catch(_){}
                validateAndSync();
            }
            mask.addEventListener('input', applyMask);

            mask.addEventListener('paste', (e)=>{
                e.preventDefault();
                const txt = (e.clipboardData||window.clipboardData).getData('text') || '';
                const raw = txt.replace(/\D/g,'').slice(0,8);
                let f = '';
                if(raw.length<=2) f=raw;
                else if(raw.length<=4) f = raw.slice(0,2)+'/'+raw.slice(2);
                else f = raw.slice(0,2)+'/'+raw.slice(2,4)+'/'+raw.slice(4);
                mask.value = f;
                const end = mask.value.length;
                try{ mask.setSelectionRange(end,end); }catch(_){}
                validateAndSync();
            });

            native.addEventListener('change', ()=>{
                if(!native.value) return;
                const [y,m,d] = native.value.split('-').map(Number);
                const picked = new Date(y, m-1, d, 0,0,0,0);
                mask.value = toBR(picked);
                validateAndSync();
            });

            function openPicker(){
                if (typeof native.showPicker === 'function') native.showPicker();
                else { native.focus(); native.click(); }
            }
            wrapper.addEventListener('click', (e)=>{
                if (e.target === mask) return;
                openPicker();
            });
            document.getElementById('icon-cal-expire').addEventListener('click', openPicker);

            function validateAndSync(){
                const dt = parseBR(mask.value);
                const ok = !!dt && dt >= today0();
                if (ok){
                hidden.value = toISO(dt);
                mask.classList.add('is-valid');
                mask.classList.remove('is-invalid');
                feedback.style.display = 'none';
                }else{
                hidden.value = '';
                mask.classList.add('is-invalid');
                mask.classList.remove('is-valid');
                feedback.style.display = 'block';
                }
                return ok;
            }

            (function init(){
                if (hidden.value){
                const [y,m,d] = hidden.value.split('-').map(Number);
                const dt = new Date(y, m-1, d, 0,0,0,0);
                native.value = hidden.value;
                mask.value = toBR(dt);
                }
                validateAndSync();
            })();

            const form = document.getElementById('formDtExpire');
            const btnConfirmarSalvar = document.getElementById('btnConfirmarSalvar');
            const spinnerSalvar = document.getElementById('loading-spinner-salvar');
            const btnConfirmarText = btnConfirmarSalvar.querySelector('.btn-text');
            let = locked = false;

            if (btnConfirmarSalvar){
                btnConfirmarSalvar.addEventListener('click', function(){
                if (locked) return;
                    locked = true;

                btnConfirmarText.textContent = '';
                const ok = validateAndSync();
                if (!ok){
                    if (spinnerSalvar) spinnerSalvar.style.display = 'none';
                    return;
                }
                if (spinnerSalvar) spinnerSalvar.style.display = 'inline-block';
                form.submit();
                });
            }
            })();
        </script>
    </body>
</html>

