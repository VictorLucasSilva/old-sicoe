{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SICOE - Sistema de Controle de Estabelecimento</title>

    <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="icon" href="{% static 'images/BBTS.png' %}" type="image/x-icon">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <style>
      .button-center{
        display:inline-block; padding:7px 14px; margin:5px; border:none; border-radius:6px;
        font-weight:bold; text-decoration:none; color:white; cursor:pointer; transition:background-color .3s ease;
      }
      .btn-success{ background-color:rgb(115,134,255); }
      .btn-warning{ background-color:rgb(254,254,98); color:#465EFF; }
      .btn-secondary{ background-color:#6c757d; }
      .button-center:hover{ opacity:.9; }

      .conteudo{ display:flex; flex-direction:column; gap:0px; }
      .section-content-1{ padding:15px; }
      .section-1-title{ display:flex; justify-content:space-between; align-items:center; }
      .section-content-2{
        padding:17px; border:1px solid #ddd; border-radius:6px; background-color:#fff; display:flex; align-items:center;
      }
      .regiao-nome{ min-width:150px; font-weight:bold; margin-left:3px; }
      .botoes-centro{ display:flex; flex-wrap:wrap; margin-left:10px; }

      .btn-visao-geral{
        background-color:#465EFF; color:white; margin-left:20px; padding:7px 14px; border:none; border-radius:6px;
        font-weight:bold; text-decoration:none; cursor:pointer; transition:background-color .3s ease;
      }
      .btn-visao-geral:hover{ opacity:.9; }

      .regiao-bloco{
        margin-top:35px; margin-bottom:25px; padding:25px; background-color:#f5f5f5; border-radius:8px; text-align:left;
      }
      .regiao-titulo{ font-size:1.4rem; font-weight:bold; margin-bottom:20px; text-align:center; }
      .centro-nome{ font-weight:600; font-size:1.1rem; margin-top:10px; text-align:center; }

      .documentos-lista{
        list-style:none; padding:0; color:#000; font-weight:bold; display:block; text-align:left; width:100%;
      }
      .documentos-lista li{
        display:flex; align-items:center; justify-content:flex-start; gap:.5rem; margin:10px 10px 20px 28px; flex-wrap:nowrap;
      }
      .attach-btn{ margin-right:.5rem; }

      .table-div{
        background-color:#FFF; transition:.4s; color:black; box-shadow:.2rem .2rem .3rem .1rem rgb(191,191,191);
        height:8rem; border-radius:.25rem; display:flex; flex-direction:column; justify-content:center; align-items:center; overflow:hidden;
      }

      .invalid-alert{
        background-color: rgba(var(--bs-emphasis-color-rgb), .01);
        border: 1.5px solid rgba(var(--bs-emphasis-color-rgb), .15);
        color:#000;
      }

      .inline-alert{
        margin-left: 2rem; display:inline-flex; align-items:center; gap:.5rem; padding:.375rem .5rem; border-radius:.25rem;
        text-align:left; font-size:.9rem;
      }

      .inline-alert .alert-title{ margin:0; white-space:nowrap; }

      .inline-alert .alert-body{
        font-weight:400; 
        white-space:pre-wrap; overflow-wrap:anywhere;
      }

       .inline-alert .alert-title{ color: #3c3c3cff; }
      .att{
        margin-bottom: 30px;
      }

      @media (max-width: 768px){
        .documentos-lista li{ flex-wrap:wrap; }
        .inline-alert{ width:100%; margin-left:0; margin-top:.5rem; }
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
      {% include "others/sidebar.html" %}
      <div class="main">
        <nav class="navbar navbar-expand px-4 py-2">
          <a href="{% url 'home_audit' %}" class="navbar-text-lg-start inline pt-2 d-flex align-items-center">
            <img src="{% static 'images/BBTS.png' %}" alt="Logo" class="mx-3 mb-2" />
            <h3 class="mx-3"><strong>Sistema de Controle de Estabelecimento - SICOE</strong></h3>
          </a>
        </nav>

        <main class="content px-3 py-4">
          {% if messages %}
          <div id="msg-container" class="position-fixed top-0 start-50 translate-middle-x p-3" style="z-index:1080; width:fit-content; max-width:90%;">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show mb-2" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
              </div>
            {% endfor %}
          </div>
          {% endif %}

          <div class="container-fluid">
            <div class="mb-3">
              <div class="row">
                <div class="col-12 col-lg-12 col-md-12 pb-4 mt-3">
                  <div class="row">
                    <div class="col-12 col-lg-5 col-md-12 mb-3 mx-auto">
                      <div class="card border-0">
                        <div class="card-body py-4 d-flex flex-column align-items-center justify-content-center text-center">
                          <h5 class="mb-4 fw-bold fs-4">Regularidade dos Anexos</h5>
                          <h6 class="mb-2 fs-5">{{ regularity }}</h6>
                        </div>
                      </div>
                    </div>
                    <div class="col-12 col-lg-7 col-md-12 pb-4">
                      <div class="table-div py-3 border-1">
                        <div>
                          <table class="table table-md">
                            <thead>
                              <tr>
                                <th class="fs-5">Vencidos</th>
                                <th class="fs-5">Invalidados</th>
                                <th class="fs-5">A Vencer</th>
                                <th class="fs-5">Em An√°lise</th>
                                <th class="fs-5">Regulares</th>
                              </tr>
                            </thead>
                            <tbody>
                              <tr>
                                <td class="fs-5">{{ count_expire }}</td>
                                <td class="fs-5">{{ count_invalid }}</td>
                                <td class="fs-5">{{ count_avencer }}</td>
                                <td class="fs-5">{{ count_analise }}</td>
                                <td class="fs-5">{{ count_regular }}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="row">
                    <div class="col-12 col-lg-12 col-md-12">
                      <div class="main-s border-1">
                        <div class="titulo">
                          <span>Estabelecimentos com Pend√™ncias</span>
                        </div>
                        <div class="control-sections-s">
                          <div class="conteudo">
                            <div class="section-content-2" id="regiao-NORTE"><div class="regiao-nome">NORTE</div><div class="botoes-centro"></div></div>
                            <div class="section-content-2" id="regiao-NORDESTE"><div class="regiao-nome">NORDESTE</div><div class="botoes-centro"></div></div>
                            <div class="section-content-2" id="regiao-CENTRO-OESTE"><div class="regiao-nome">CENTRO-OESTE</div><div class="botoes-centro"></div></div>
                            <div class="section-content-2" id="regiao-SUDESTE"><div class="regiao-nome">SUDESTE</div><div class="botoes-centro"></div></div>
                            <div class="section-content-2" id="regiao-SUL"><div class="regiao-nome">SUL</div><div class="botoes-centro"></div></div>
                          </div>
                        </div>
                      </div>

                      <div class="modal fade" id="exampleModal" tabindex="-1">
                        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                          <div class="modal-content">
                            <div class="modal-header">
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                              <table class="table table-striped table-bordered">
                                <thead>
                                  <tr>
                                    <th></th>
                                    <th><strong>Estabelecimentos com Pend√™ncias</strong></th>
                                    <th class="att"><strong>Anexos Pendentes</strong></th>
                                  </tr>
                                </thead>
                                <tbody>
                                  <tr><th>Norte</th><td id="modal-estab-norte"></td><td id="modal-anexo-norte"></td></tr>
                                  <tr><th>Nordeste</th><td id="modal-estab-nordeste"></td><td id="modal-anexo-nordeste"></td></tr>
                                  <tr><th>Centro-Oeste</th><td id="modal-estab-centro"></td><td id="modal-anexo-centro"></td></tr>
                                  <tr><th>Sudeste</th><td id="modal-estab-sudeste"></td><td id="modal-anexo-sudeste"></td></tr>
                                  <tr><th>Sul</th><td id="modal-estab-sul"></td><td id="modal-anexo-sul"></td></tr>
                                </tbody>
                              </table>

                              <h4 style="text-align:center; margin-top:45px;">Detalhamento dos Estabelecimentos com Pend√™ncias</h4>
                              <div id="modal-detalhes-estab"></div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="modal fade" id="centerModal" tabindex="-1">
                        <div class="modal-dialog modal-lg modal-dialog-centered">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title" id="centerModalLabel"><strong>Informa√ß√µes do Estabelecimento</strong></h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                              <h5 id="titulo-centro" class="text-primary fw-bold" style="text-align:center; margin-bottom:25px;"></h5>

                              <h6><strong>üë§ Respons√°veis pelo Estabelecimento</strong></h6>
                              <table class="table table-sm table-bordered">
                                <thead>
                                  <tr>
                                    <th>Nome</th><th>Email</th><th>Perfil</th><th>√Årea Gestora</th>
                                  </tr>
                                </thead>
                                <tbody id="user-table-body"></tbody>
                              </table>

                              <div id="info-invalidado" style="display:none; margin-top:30px;"></div>
                            </div>
                          </div>
                        </div>
                      </div>

                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="{% static 'js/script.js' %}"></script>

    <script>

      document.addEventListener('DOMContentLoaded', function () {
        const msgContainer = document.getElementById('msg-container');
        if (msgContainer) {
          setTimeout(() => {
            [...msgContainer.querySelectorAll('.alert')].forEach(alert => {
              const bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
              bsAlert.close();
            });
          }, 8000);
        }
      });
    </script>

    <script>

      function esc(s){
        return String(s ?? '')
          .replace(/&/g,'&amp;')
          .replace(/</g,'&lt;')
          .replace(/>/g,'&gt;')
          .replace(/"/g,'&quot;')
          .replace(/'/g,'&#39;');
      }

      const regionCenters = {{ region_centers_json|safe }};
      const centersData   = {{ centers_data_json|safe }};
      const invalidByDoc  = {{ invalid_by_document_json|safe }};
      const ATTACH_PREFIX = "/administrador/anexo/cadastrar/";

      for (const [region, centers] of Object.entries(regionCenters)) {
        const container = document.querySelector(`#regiao-${region} .botoes-centro`);
        if (!container) continue;

        centers.forEach(({ name, status }) => {
          const btn = document.createElement("a");
          btn.href = "#";
          btn.className = `button-center btn-sm btn-${status}`;
          btn.textContent = name;
          btn.setAttribute("data-bs-toggle", "modal");
          btn.setAttribute("data-bs-target", "#centerModal");

          btn.addEventListener("click", () => {
            const data = centersData[name];
            const tbody = document.getElementById("user-table-body");
            const section = document.getElementById("info-invalidado");
            document.getElementById("titulo-centro").innerHTML = esc(name);

            tbody.innerHTML = "";
            if (data.users.length > 0) {
              data.users.forEach(user => {
                tbody.innerHTML += `<tr>
                  <td>${esc(user.name)}</td>
                  <td>${esc(user.email)}</td>
                  <td>${esc(user.profile)}</td>
                  <td>${esc(data.manage)}</td>
                </tr>`;
              });
            } else {
              tbody.innerHTML = `<tr><td colspan="4">Nenhum usu√°rio associado.</td></tr>`;
            }

            section.innerHTML = "";
            if (data.invalidado && data.invalidado.length > 0) {
              section.style.display = "block";
              const centerId = data.center || data.center_code || name;

              let html = `<h6 class='att'><strong>üìÑ Anexos Pendentes</strong></h6><ul class='documentos-lista'>`;
              data.invalidado.forEach(doc => {
                const docId = doc.document;
                const url = ATTACH_PREFIX + encodeURIComponent(docId) + "/" + encodeURIComponent(centerId) + "/";

                const sit = (doc.situation || '').toLowerCase();
                const just = (doc.justification || '').trim();

                html += `<li class="doc-item">
                  <a href="${url}" class="btn btn-sm btn-primary attach-btn" title="Anexar documento">
                    <i class="bi bi-paperclip"></i> Anexar
                  </a>
                  <span class="doc-name">${esc(docId)}</span>
                  ${ (sit.includes('invalidado') && just) ? `
                  <div class="alert invalid-alert inline-alert mb-0" role="alert">
                    <div class="d-flex align-items-start gap-2 flex-nowrap">
                      <div class="alert-title flex-shrink-0">Motivo da Invalida√ß√£o :</div>
                      <div class="alert-body flex-grow-1 text-start">${esc(just)}</div>
                    </div>
                  </div>` : ``}
                </li>`;
              });
              html += `</ul>`;
              section.innerHTML = html;
            } else {
              section.style.display = "none";
            }
          });

          container.appendChild(btn);
        });
      }

      const regionKeys = { 'NORTE':'norte','NORDESTE':'nordeste','CENTRO-OESTE':'centro','SUDESTE':'sudeste','SUL':'sul' };
      for (const [reg, slug] of Object.entries(regionKeys)) {
        const centers = regionCenters[reg] || [];
        const pendingCenters = centers.filter(c => centersData[c.name]?.invalidado?.length > 0);
        const totalEstabs = pendingCenters.length;
        let totalAnexos = 0;
        pendingCenters.forEach(c => {
          const invalids = centersData[c.name]?.invalidado || [];
          totalAnexos += invalids.length;
        });
        const estCell = document.getElementById(`modal-estab-${slug}`);
        const anCell  = document.getElementById(`modal-anexo-${slug}`);
        if (estCell) estCell.textContent = totalEstabs;
        if (anCell)  anCell.textContent  = totalAnexos;
      }

      const detalhesContainer = document.getElementById("modal-detalhes-estab");
      const porRegiao = {};
      for (const [nomeCentro, dados] of Object.entries(centersData)) {
        const region = (dados.region || '').toUpperCase() || '-';
        if (!dados.invalidado || dados.invalidado.length === 0) continue;
        porRegiao[region] = porRegiao[region] || [];
        porRegiao[region].push({
          nome: nomeCentro,
          centerId: dados.center || dados.center_code || nomeCentro,
          documentos: dados.invalidado.map(d => ({
            document: d.document,
            situation: d.situation,
            justification: d.justification
          }))
        });
      }

      const ordemRegioes = ['NORTE','NORDESTE','CENTRO-OESTE','SUDESTE','SUL'];
      ordemRegioes.forEach(regiao => {
        const centros = porRegiao[regiao];
        if (!centros) return;

        const bloco = document.createElement("div");
        bloco.className = "regiao-bloco";
        let html = `<div class="regiao-titulo">üó∫Ô∏è ${regiao}</div>`;

        centros.forEach(c => {
          html += `<div class="centro-nome">üìå ${esc(c.nome)}</div>`;
          html += `<ul class="documentos-lista">`;

          c.documentos.forEach(d => {
            const url = ATTACH_PREFIX + encodeURIComponent(d.document) + "/" + encodeURIComponent(c.centerId) + "/";
            const sit = (d.situation || '').toLowerCase();
            const just = (d.justification || '').trim();

            html += `<li class="doc-item">
              <a href="${url}" class="btn btn-sm btn-primary attach-btn" title="Anexar documento">
                <i class="bi bi-paperclip"></i> Anexar
              </a>
              <span class="doc-name">${esc(d.document)}</span>
              ${ (sit.includes('invalidado') && just) ? `
              <div class="alert invalid-alert inline-alert mb-0" role="alert">
                <div class="d-flex align-items-start gap-2 flex-nowrap">
                  <div class="alert-title flex-shrink-0">Motivo da Invalida√ß√£o :</div>
                  <div class="alert-body flex-grow-1 text-start">${esc(just)}</div>
                </div>
              </div>` : ``}
            </li>`;
          });

          html += `</ul>`;
        });

        bloco.innerHTML = html;
        detalhesContainer.appendChild(bloco);
      });
    </script>
  </body>
</html>
