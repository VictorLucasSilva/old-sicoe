{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel de Estabelecimentos</title>

  <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
        crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">

  <style>
    .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .table-div-all{
      background:#FFF; transition:.4s; cursor:pointer; color:#000; height:100%;
      border-radius:.25rem; display:flex; flex-direction:column; justify-content:flex-start;
      padding:15px; box-shadow:.2rem .2rem .3rem .1rem rgb(191,191,191);
    }
    .table-div-all .table{ font-size:1.3rem; width:100%; table-layout:fixed; text-align:center; }
    .table-div-all .table, .table-div-all .table td{
      word-wrap:break-word; vertical-align:middle; font-size:.80rem;
    }
    .dropdown-menu.filtro-menu{
      max-height:40vh; overflow-y:auto; overflow-x:hidden;
      overscroll-behavior:contain; -webkit-overflow-scrolling:touch;
    }
    :root{
      --filtro-borda: #aaaaaaff;    
    }
    .filters .form-control,
    .filters .dropdown > .btn,
    .filters .input-group-text{
      border-color: var(--filtro-borda);
      border-width: 1px;           
      border-radius: .300rem;      
    }
    .filters .input-group .input-group-text{
      background: #fff;           
      border-right-color: var(--filtro-borda);
    }
    .filters .input-group .form-control{
      border-left-color: var(--filtro-borda);
    }
    .filters .form-control:focus,
    .filters .dropdown > .btn:focus,
    .filters .dropdown > .btn.show{
      box-shadow: 0 0 0 .2rem var(--filtro-glow);
    }

    .filters .dropdown > .btn-outline-secondary{
      --bs-btn-border-color: var(--filtro-borda);
      --bs-btn-hover-border-color: var(--filtro-borda-focus);
      --bs-btn-focus-shadow-rgb: 37,99,235; 
    }

    .filters .dropdown-menu{
      border-color: var(--filtro-borda);
    }

    .wnoty-stack{
      position:fixed; top:0.37rem; right:1.54rem;
      width: min(380px, 92vw);
      display:flex; flex-direction:column; gap:.6rem;
      z-index:1080;
    }

    .wnoty-item{
      position:relative;
      display:flex; align-items:center; gap:.75rem;
      background:#fff; border-radius:.3rem;
      box-shadow: 0 .35rem .85rem rgba(0,0,0,.12);
      padding:.75rem .9rem .75rem .75rem;
      animation:wnoty-in .18s ease-out both;
    }

    .wnoty-colorbar{
      position:absolute; left:0; top:0; bottom:0; width:.35rem;
      border-top-left-radius:.6rem; border-bottom-left-radius:.6rem;
      background:var(--accent);
    }

    .wnoty-icon{
      width:2rem; height:2rem; border-radius:50%;
      display:grid; place-items:center; font-size:1.05rem;
      background:var(--accent-weak); color:var(--accent);
      flex:0 0 auto;
    }

    .wnoty-text{ flex:1; font-size:.95rem; }
    .wnoty-close{
      border:0; background:transparent; font-size:1.2rem;
      line-height:1; opacity:.55; cursor:pointer;
    }
    .wnoty-close:hover{ opacity:.9; }

    .wnoty-success{ --accent:#28a745; --accent-weak:#EAF7EE; }
    .wnoty-info   { --accent:#0dcaf0; --accent-weak:#E7FAFF; }
    .wnoty-warning{ --accent:#ffc107; --accent-weak:#FFF8E1; }
    .wnoty-danger { --accent:#dc3545; --accent-weak:#FDECEE; }

    @keyframes wnoty-in { from{ transform:translateX(16px); opacity:.0 } to{ transform:none; opacity:1 } }
    @keyframes wnoty-out{ to{ transform:translateX(16px); opacity:.0 } }
    .wnoty-hide   { animation:wnoty-out .18s ease-in forwards; }

  </style>
</head>
<body>
<div class="wrapper">
  {% include "others/sidebar.html" %}
  <div class="main">
    <nav class="navbar navbar-expand px-4 py-2">
      <a href="#" class="navbar-text-lg-start inline pt-2 d-flex align-items-center">
        <img src="{% static 'images/BBTS.png' %}" alt="Logo" class="mx-3 mb-2" />
        <h3 class="mx-3"><strong>Sistema de Controle de Estabelecimento - SICOE</strong></h3>
      </a>
    </nav>

    <main class="content px-3 py-4">
      <div id="wnoty" class="wnoty-stack">
        {% for message in messages %}
          {% if 'success' in message.tags %}
            {% with type='success' icon='bi-check-circle' %}
              <div class="wnoty-item wnoty-{{ type }}" role="status">
                <div class="wnoty-colorbar"></div>
                <div class="wnoty-icon"><i class="bi {{ icon }}"></i></div>
                <div class="wnoty-text">{{ message }}</div>
                <button class="wnoty-close" aria-label="Fechar">&times;</button>
              </div>
            {% endwith %}
          {% elif 'info' in message.tags %}
            {% with type='info' icon='bi-info-circle' %}
              <div class="wnoty-item wnoty-{{ type }}" role="status">
                <div class="wnoty-colorbar"></div>
                <div class="wnoty-icon"><i class="bi {{ icon }}"></i></div>
                <div class="wnoty-text">{{ message }}</div>
                <button class="wnoty-close" aria-label="Fechar">&times;</button>
              </div>
            {% endwith %}
          {% elif 'warning' in message.tags %}
            {% with type='warning' icon='bi-exclamation-triangle' %}
              <div class="wnoty-item wnoty-{{ type }}" role="status">
                <div class="wnoty-colorbar"></div>
                <div class="wnoty-icon"><i class="bi {{ icon }}"></i></div>
                <div class="wnoty-text">{{ message }}</div>
                <button class="wnoty-close" aria-label="Fechar">&times;</button>
              </div>
            {% endwith %}
          {% elif 'danger' in message.tags or 'error' in message.tags %}
            {% with type='danger' icon='bi-x-circle' %}
              <div class="wnoty-item wnoty-{{ type }}" role="status">
                <div class="wnoty-colorbar"></div>
                <div class="wnoty-icon"><i class="bi {{ icon }}"></i></div>
                <div class="wnoty-text">{{ message }}</div>
                <button class="wnoty-close" aria-label="Fechar">&times;</button>
              </div>
            {% endwith %}
          {% else %}
            {% with type='info' icon='bi-info-circle' %}
              <div class="wnoty-item wnoty-{{ type }}" role="status">
                <div class="wnoty-colorbar"></div>
                <div class="wnoty-icon"><i class="bi {{ icon }}"></i></div>
                <div class="wnoty-text">{{ message }}</div>
                <button class="wnoty-close" aria-label="Fechar">&times;</button>
              </div>
            {% endwith %}
          {% endif %}
        {% endfor %}
      </div> 

      <div class="container-fluid">
        <div class="mb-3">
          <div class="row">
            <div class="col-12 col-lg-12 col-md-12 pb-3 mt-2">
              <div class="breadcrumb-div py-3 border-1">
                <ol class="breadcrumb my-1 mx-2 px-3">
                  <li class="breadcrumb-item"><a href="{% url 'home' %}">Início</a></li>
                  <li class="breadcrumb-item active" aria-current="page">Documentos</li>
                </ol>
                <h1 class="fw-bold fs-2 mx-5 mt-3">Documentos</h1>
              </div>
            </div>

            <div class="col-12 col-lg-12 col-md-12">
              <div class="table-div-all py-4 px-4 border-1">
                <div class="col-12 col-lg-12 col-md-12 mb-3">
                  <div class="table-div-all py-3 px-3 border-1">
                    <div class="small mt-3 mx-3">
                      <a href="{% url 'document_create' %}" class="btn btn-primary"><strong>Cadastrar</strong></a>
                    </div>

                    <div class="my-3 mx-3">
                      Exibindo <b id="count-start">{{ page_obj.start_index }}</b>-<b id="count-end">{{ page_obj.end_index }}</b>
                      de <b id="count-total">{{ page_obj.paginator.count }}</b> itens.
                    </div>
                  </div>
                </div>

                <div class="col-12 col-lg-12 col-md-12 mb-4">
                  <div class="table-div-all py-3 px-3 border-1">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover align-middle small">
                        <thead>
                          <tr>
                            <th width="220px">Documento</th>
                            <th class="text-center">&nbsp;</th>
                          </tr>
                            <tr class="filters">
                            <td>
                                <input type="text" id="name-filter" class="form-control form-control-sm" placeholder="">
                            </td>
                            <td></td>
                            </tr>
                        </thead>

                        <tbody id="document-body">
                          {% for document in page_obj %}
                            <tr>
                              <td>{{ document.d_doc }}</td>
                              <td>
                                <div class="d-flex justify-content-end">
                                  <form id="delete-form-{{ document.d_id }}"
                                        method="POST"
                                        action="{% url 'document_delete' document.d_id %}"
                                        style="display:inline;">
                                    <a href="{% url 'document_update' document.d_id %}" class="btn btn-sm btn-outline-primary">Editar</a>
                                    {% csrf_token %}
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            data-bs-toggle="modal"
                                            data-bs-target="#deleteModal"
                                            data-id="{{ document.d_id }}">
                                      Excluir
                                    </button>
                                  </form>
                                </div>
                              </td>
                            </tr>
                          {% empty %}
                            <tr><td colspan="2">Nenhum documento encontrado.</td></tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>

                <nav class="mt-4" aria-label="Page navigation" id="pag">
                  <ul class="pagination justify-content-center" id="pagination">
                    {% if page_obj.has_previous %}
                      <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
                    {% else %}
                      <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    {% if page_obj.number < 10 %}
                      {% for num in page_obj.paginator.page_range %}
                        {% if num <= 10 %}
                          {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                          {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                          {% endif %}
                        {% endif %}
                      {% endfor %}
                    {% else %}
                      {% for num in page_obj.paginator.page_range %}
                        {% if num >= page_obj.number|add:"-9" and num <= page_obj.number %}
                          {% if page_obj.number == num %}
                            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                          {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                          {% endif %}
                          {% endif %}
                          {% endfor %}
                          {% endif %}
                          
                          {% if page_obj.has_next %}
                          <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
                          {% else %}
                          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                          {% endif %}
                        </ul>
                      </nav>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteModalLabel">Confirmar Exclusão</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">Tem certeza de que deseja excluir este documento?</div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
              Confirmar
              <span id="loading-spinner" class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" style="display:none;"></span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>

<script src="{% static 'js/script.js' %}"></script>
<script>
  const CSRF_TOKEN = (function() {
    const tpl = '{{ csrf_token }}';
    if (tpl && tpl !== 'NOTPROVIDED') return tpl;
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return '';
    }
    return getCookie('csrftoken') || '';
  })();
</script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const stack  = document.getElementById('wnoty');               // pode existir ou não
    const items  = stack ? stack.querySelectorAll('.wnoty-item')
                        : document.querySelectorAll('.wnoty-item');

    function dismiss(el){
      el.classList.add('wnoty-hide');
      const onEnd = () => { el.removeEventListener('animationend', onEnd); el.remove(); };
      el.addEventListener('animationend', onEnd, { once:true });
      setTimeout(onEnd, 400); 
    }

    items.forEach((el, i) => {
      el.querySelector('.wnoty-close')?.addEventListener('click', () => dismiss(el));
      const AUTO_CLOSE = parseInt(el.dataset.autoclose || '5000', 10); // default 5s
      const STAGGER    = 0; 
      setTimeout(() => dismiss(el), AUTO_CLOSE + i*STAGGER);
    });
  });
  $.ajaxSetup({ headers: { 'X-Requested-With': 'XMLHttpRequest' } });

  $(function () {
    let documentIdToDelete = null;
    $(document).on('click', '.btn-outline-danger[data-id]', function (e) {
      e.preventDefault();
      documentIdToDelete = $(this).data('id');
      $('#deleteModal').modal('show');
    });

    $('#confirmDeleteBtn').on('click', function () {
      if (documentIdToDelete) {
        $('#delete-form-' + documentIdToDelete).submit();
      }
    });

    const esc = (s) => (s ?? '').toString().replace(/&/g,'&amp;').replace(/</g,'&lt;');
    const FIELDS = [
      { id:'#name-filter', param:'name', key:'d_doc', label:'Documento' }
    ];
    const optionTokens = { name: 0 };
    let latestLoadToken = 0;
    let pendingCloseParam = null;

    function ensureDropdown(field) {
    const $node = $(field.id);
    if (!$node.length) return;

    if ($node.closest('.dropdown').length) return;

    if ($node.is('input[type="hidden"]')) return;

    const id = $node.attr('id');
    const currentVal = ($node.val && $node.val()) || '';

    const $wrap = $(`
        <div class="dropdown w-100" data-bs-boundary="viewport">
        <button type="button"
                class="btn btn-sm btn-outline-secondary w-100 text-truncate"
                data-bs-toggle="dropdown"
                data-bs-auto-close="outside"
                data-bs-display="static"
                aria-expanded="false"
                title="${esc(field.label)}">Todos</button>
        <ul class="dropdown-menu filtro-menu w-100 p-0" data-param="${field.param}"></ul>
        <input type="hidden" id="${id}">
        </div>
    `);

    $node.replaceWith($wrap);

    const $hidden = $wrap.find('input[type="hidden"]');
    $hidden.val(currentVal);

    $wrap.attr('data-enhanced', '1');
    $hidden.attr('data-enhanced', '1');

    rebuildDropdownOptions(field, [], false);
    }

    function els(field){
      const $hidden = $(field.id);
      const $wrap   = $hidden.closest('.dropdown');
      return { $hidden, $wrap, $menu: $wrap.find('.dropdown-menu'), $btn: $wrap.find('[data-bs-toggle="dropdown"]') };
    }

    function setDropdownLoading(field){
      const { $menu } = els(field);
      $menu.html(`
        <li><button type="button" class="dropdown-item" data-value="">Todos</button></li>
        <li><div class="px-3 py-2 small text-body-secondary">Carregando opções…</div></li>
      `);
    }

    function rebuildDropdownOptions(field, values, keepSelection){
      const { $menu, $hidden, $btn } = els(field);
      const prev = (keepSelection ? $hidden.val() : '') || '';
      let html = `<li><button type="button" class="dropdown-item${prev===''?' active':''}" data-value="">Todos</button></li>`;
      values.forEach(v => {
        const isActive = (v === prev) ? ' active' : '';
        html += `<li><button type="button" class="dropdown-item${isActive}" data-value="${esc(v)}" title="${esc(v)}">${esc(v)}</button></li>`;
      });
      $menu.html(html);
      $btn.text(prev || 'Todos').attr('title', prev || 'Todos');
    }

    $(document).on('show.bs.dropdown', '.dropdown', function(){
      const $menu = $(this).find('.dropdown-menu');
      const rect  = this.getBoundingClientRect();
      const avail = Math.max(120, Math.floor(window.innerHeight - rect.bottom - 8));
      $menu.css({ 'max-height': `${avail}px`, 'overflow-y': 'auto', 'overflow-x': 'hidden' });
    });

    $(document).on('click', '.dropdown-menu[data-param] .dropdown-item', function(e){
      e.preventDefault();
      const $menu = $(this).closest('.dropdown-menu');
      const param = $menu.data('param');
      const field = FIELDS.find(f => f.param === param);
      if (!field) return;

      const value = $(this).data('value') || '';
      const { $hidden, $btn } = els(field);

      $menu.find('.dropdown-item.active').removeClass('active');
      $(this).addClass('active');

      $hidden.val(value).trigger('change'); 
      $btn.text(value || 'Todos').attr('title', value || 'Todos');

      pendingCloseParam = field.param;
    });

    FIELDS.forEach(ensureDropdown);

    function renderRows(items) {
      const $tbody = $('#document-body').empty();
      if (!Array.isArray(items) || !items.length) {
        $tbody.append('<tr><td colspan="2">Nenhum documento encontrado.</td></tr>');
        return;
      }
      items.forEach(doc => {
        const safe = esc(doc.d_doc || '');
        const editUrl = doc.edit_url || (`/administrador/documento/${doc.d_id}/editar/`);
        const delUrl  = doc.delete_url|| (`/administrador/documento/${doc.d_id}/excluir/`);
        $tbody.append(`
          <tr>
            <td>${safe}</td>
            <td>
              <div class="d-flex justify-content-end">
                <form id="delete-form-${doc.d_id}" method="POST" action="${delUrl}" style="display:inline;">
                  <a href="${editUrl}" class="btn btn-sm btn-outline-primary">Editar</a>
                  <input type="hidden" name="csrfmiddlewaretoken" value="${CSRF_TOKEN}">
                  <button type="button"
                          class="btn btn-sm btn-outline-danger"
                          data-bs-toggle="modal"
                          data-bs-target="#deleteModal"
                          data-id="${doc.d_id}">
                    Excluir
                  </button>
                </form>
              </div>
            </td>
          </tr>
        `);
      });
    }

    function renderCounters(start, end, total) {
      $('#count-start').text(start ?? 0);
      $('#count-end').text(end ?? 0);
      $('#count-total').text(total ?? 0);
    }

    function renderPagination(current, total){
      const pag = document.getElementById('pagination');
      if (!pag) return;
      pag.innerHTML = '';
      const start = Math.max(1, current - 9);
      const end   = Math.min(total, start + 9);

      if (current > 1) {
        pag.innerHTML += `<li class="page-item">
          <a class="page-link" href="?page=${current - 1}" data-page="${current - 1}" aria-label="Anterior">&laquo;</a>
        </li>`;
      } else {
        pag.innerHTML += `<li class="page-item disabled">
          <span class="page-link" aria-disabled="true">&laquo;</span>
        </li>`;
      }
      for (let i = start; i <= end; i++) {
        if (i === current) {
          pag.innerHTML += `<li class="page-item active" aria-current="page">
            <span class="page-link">${i}</span>
          </li>`;
        } else {
          pag.innerHTML += `<li class="page-item">
            <a class="page-link" href="?page=${i}" data-page="${i}">${i}</a>
          </li>`;
        }
      }
      if (current < total) {
        pag.innerHTML += `<li class="page-item">
          <a class="page-link" href="?page=${current + 1}" data-page="${current + 1}" aria-label="Próxima">&raquo;</a>
        </li>`;
      } else {
        pag.innerHTML += `<li class="page-item disabled">
          <span class="page-link" aria-disabled="true">&raquo;</span>
        </li>`;
      }
    }

    function returnDropdownToPlace() {
      if (!pendingCloseParam) return;
      const field = FIELDS.find(f => f.param === pendingCloseParam);
      if (!field) { pendingCloseParam = null; return; }

      const { $wrap, $menu, $hidden } = els(field);
      const btnEl = $wrap.find('[data-bs-toggle="dropdown"]')[0];
      if (btnEl) bootstrap.Dropdown.getOrCreateInstance(btnEl).hide();

      const selected = $hidden.val() || '';
      if (selected) rebuildDropdownOptions(field, [selected], true);
      $menu.scrollTop(0);
      pendingCloseParam = null;
    }
    function fetchPage(params) {
      return $.ajax({ url: "{% url 'document_list' %}", data: params, dataType: 'json' });
    }

    function getCurrentFilters(){
      return { name: $('#name-filter').val() || '' };
    }
    function baseFiltersExcept(except){
      const f = getCurrentFilters();
      if (except in f) f[except] = '';
      return f;
    }
    async function refreshOptionsForField(field) {
      const { $hidden } = els(field);
      const selected = $hidden.val() || '';

      if (selected) {             
        rebuildDropdownOptions(field, [selected], true);
        return;
      }

      const token = ++optionTokens[field.param];
      const base  = baseFiltersExcept(field.param);
      setDropdownLoading(field);

      try {
        const first = await fetchPage({ ...base, page: 1 });
        if (token !== optionTokens[field.param]) return;

        const totalPages = Math.max(1, first.num_pages || 1);
        const seen = new Set();
        const values = [];
        (first.results || []).forEach(r => {
          const v = (r[field.key] || '').toString();
          if (v && !seen.has(v)) { seen.add(v); values.push(v); }
        });
        rebuildDropdownOptions(field, values, true);

        if (totalPages > 1) {
          const jobs = [];
          for (let p=2; p<=totalPages; p++) {
            jobs.push(
              fetchPage({ ...base, page: p }).then(pg => {
                if (token !== optionTokens[field.param]) return;
                const adds = [];
                (pg.results || []).forEach(r => {
                  const v = (r[field.key] || '').toString();
                  if (v && !seen.has(v)) { seen.add(v); adds.push(v); }
                });
                if (adds.length) {
                  values.push(...adds);
                  rebuildDropdownOptions(field, values, true);
                }
              }).catch(()=>{})
            );
          }
          await Promise.allSettled(jobs);
        }
      } finally {
        const { $menu } = els(field);
        $menu.find('.text-body-secondary:contains("Carregando")').closest('li').remove();
      }
    }
    async function refreshAllOptions(){ await Promise.allSettled(FIELDS.map(refreshOptionsForField)); }
    function loadDocs(page=1){
      const token = ++latestLoadToken;
      const params = { ...getCurrentFilters(), page };
      fetchPage(params).done(async (data) => {
        if (token !== latestLoadToken) return;
        renderRows(data.results || []);
        renderCounters(data.start_index ?? 0, data.end_index ?? 0, data.count ?? 0);
        renderPagination(data.current_page ?? 1, data.num_pages ?? 1);

        await refreshAllOptions();
        returnDropdownToPlace();
      }).fail(() => {
        $('#document-body').html('<tr><td colspan="2">Erro ao carregar dados.</td></tr>');
      });
    }

    $(document).on('change', '#name-filter', function(){ loadDocs(1); });
    $('#pagination').on('click', 'a.page-link', function(e){
      e.preventDefault();
      const href = $(this).attr('href') || '';
      const qs   = href.split('?')[1] || '';
      const page = $(this).data('page') || new URLSearchParams(qs).get('page');
      if (page) loadDocs(parseInt(page, 10));
    });

    FIELDS.forEach(ensureDropdown);
    loadDocs(1);
  });
</script>
</body>
</html>
